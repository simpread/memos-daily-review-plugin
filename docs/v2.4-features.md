# v2.4 新功能使用指南

## localStorage 配额监控

### 功能概述

v2.4 新增了主动的 localStorage 使用监控功能，帮助开发者和用户了解存储使用情况，预防配额超限错误。

### 自动监控

插件会在以下情况自动输出存储报告：

1. **定期报告**: 每 10 分钟自动输出一次
2. **清理后报告**: 历史记录清理后自动输出
3. **配额超限**: 遇到配额错误时，在清理前输出当前状态

### 手动查看存储报告

在浏览器控制台执行：

```javascript
// 获取存储统计
const stats = storageUtils.calculateStorageStats();
console.log(stats);

// 输出格式化报告
storageUtils.logStorageReport();
```

### 报告示例

```
[DailyReview] Storage Usage Report
==================================================
  pool                     45.23 KB ( 52.1%)
  history                  28.67 KB ( 33.0%)
  cache                    10.45 KB ( 12.0%)
  settings                  1.89 KB (  2.2%)
  capabilities              0.45 KB (  0.5%)
  batch                     0.12 KB (  0.1%)
  ----------------------------------------------
  Total                    86.81 KB
```

### 配额管理策略

当遇到配额超限时，插件会按以下顺序清理：

1. **清理旧的 deck 缓存** (保留最近 3 个)
2. **清理 pool 缓存** (6 小时后会自动重建)
3. **清理历史记录** (保留最近 2000 条)

清理前会输出当前存储状态，方便诊断问题。

---

## markdownToHtml 重构

### 功能概述

v2.4 对 Markdown 渲染引擎进行了重构，提升了代码可维护性和可测试性。

### 架构改进

**重构前**:
- 单个 156 行函数
- 圈复杂度 ~25
- 难以测试和扩展

**重构后**:
- `IndentDepthCalculator` 模块 (35 行) - 管理缩进深度
- `ListLevelManager` 模块 (45 行) - 管理列表嵌套
- `markdownToHtml` 主函数 (100 行) - 协调渲染流程
- 圈复杂度 ~12

### 功能保持不变

重构完全保持向后兼容，所有 Markdown 功能正常工作：

- ✅ 标题 (h1-h6)
- ✅ 无序列表 (-, *, +)
- ✅ 有序列表 (1., 2., 3.)
- ✅ 嵌套列表 (任意深度)
- ✅ 段落和换行
- ✅ 行内格式 (粗体、斜体、链接、图片)

### 测试覆盖

新增 9 个单元测试，覆盖：
- 缩进深度计算
- 列表嵌套管理
- Markdown 渲染正确性

所有现有回归测试通过，确保无破坏性变更。

---

## 开发者指南

### 扩展存储监控

如果需要添加新的存储键监控：

```javascript
// 在 CONFIG 中添加新键
const CONFIG = {
  // ...
  NEW_KEY: 'memos-daily-review-new-feature'
};

// calculateStorageStats 会自动包含所有 CONFIG 中的键
```

### 扩展 Markdown 渲染

如果需要添加新的 Markdown 语法：

```javascript
// 在 markdownToHtml 主循环中添加新的匹配规则
const customMatch = trimmed.match(/^custom-syntax$/);
if (customMatch) {
  // 处理自定义语法
  const element = document.createElement('div');
  element.className = 'custom';
  // ...
  fragment.appendChild(element);
  continue;
}
```

### 调试技巧

**查看存储使用**:
```javascript
storageUtils.logStorageReport();
```

**测试 Markdown 渲染**:
```javascript
const html = utils.markdownToHtml('# Test\n- Item 1\n  - Nested');
console.log(html);
```

**检查缩进深度**:
```javascript
const calc = utils.IndentDepthCalculator.create();
console.log(calc.getDepth(0));  // 0
console.log(calc.getDepth(2));  // 1
console.log(calc.getDepth(4));  // 2
```

---

## 性能影响

### 存储监控

- **CPU 开销**: 可忽略 (每 10 分钟一次)
- **内存开销**: 无额外内存占用
- **用户体验**: 无影响

### Markdown 重构

- **渲染速度**: 保持不变 (< 50ms for long docs)
- **内存使用**: 保持不变
- **代码大小**: 增加 ~80 行 (模块化代码)

---

## 常见问题

### Q: 存储报告会影响性能吗？

A: 不会。报告仅在以下情况生成：
- 每 10 分钟一次 (后台任务)
- 清理后 (已经在执行清理操作)
- 配额超限 (错误处理路径)

### Q: 重构后 Markdown 渲染有变化吗？

A: 没有。重构仅改变内部实现，输出完全一致。所有测试通过，确保向后兼容。

### Q: 如何禁用存储报告？

A: 存储报告仅输出到控制台，不影响用户。如需禁用，可以注释掉 `storageMonitor.checkAndCleanup()` 中的 `logStorageReport()` 调用。

### Q: 新模块会增加加载时间吗？

A: 不会。所有代码在同一个 IIFE 中，浏览器一次性加载和解析。

---

## 升级说明

从 v2.3 升级到 v2.4 无需任何操作：

1. ✅ 自动兼容现有数据
2. ✅ 无需清理缓存
3. ✅ 无需修改配置
4. ✅ 无破坏性变更

只需替换 `memos-daily-review-plugin.js` 文件即可。

---

## 反馈与贡献

如发现问题或有改进建议，请：

1. 查看 [CHANGELOG.md](../CHANGELOG.md) 了解版本历史
2. 阅读 [CONTRIBUTING.md](../CONTRIBUTING.md) 了解开发指南
3. 提交 Issue 或 Pull Request

---

**版本**: v2.4.0
**发布日期**: 2026-02-24
**维护者**: Memos Daily Review Plugin Team
